---
title: "DEP Limma 060821_barron lab"
author: "Author: Lai, Kei Onn (Barron lab) and Giuseppe D Agostino (Langley lab)"
date: "8/6/2021"
output: html_document
---

```{r setup, include=FALSE,message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(readxl)
library(xlsx)
library(DEP)
library(impute)
library(imputeLCMD)
library(dplyr)
library(SummarizedExperiment)
library(MSnbase)
library(tibble)
library(imp4p)
library(bnstruct)
library(limma)
library(EnhancedVolcano)
```

```{r}
load("DEPlimmainput050821.RData")
originallabel<-coldata$label
finalimputeddata<-data.frame(finalimputeddata)
colnames(finalimputeddata)<-originallabel
```
we add a column of positive samples (APP and WT) vs negative(KO) to denote the coldata
```{r}
coldata
coldata$samples<-as.factor(c(rep("pos",6),rep("neg",3)))
coldata
```

```{r}
finalimputeddata<-finalimputeddata %>% rownames_to_column("ID")
finalimputeddata<-merge(finalimputeddata,ID,by.x="ID",by.y="ID",all.x=TRUE)
final_imp_uniq <-make_unique(finalimputeddata, "ID", "Description")
final_se<-make_se(final_imp_uniq, 2:10, coldata)
```
Test for differentially expressed proteins with a custom design formula


```{r}
#Test for differentially expressed proteins with a custom design formula

samples<-factor(colData(final_se)$samples,levels = c("pos","neg"))


# Creating the model matrix and contrast matrix for limma
colData(final_se)
design <- model.matrix(~0+colData(final_se)$samples)
colnames(design) <- gsub("group", "", colnames(design))
colnames(design)<-c("neg","pos")
contr.matrix <- makeContrasts(posvsneg = pos-neg,
levels = colnames(design))
fit <- lmFit(assay(final_se),design)
vfit<-contrasts.fit(fit, contrasts=contr.matrix)
efit <- eBayes(vfit)
allDEP<-topTable(efit, number=Inf)
allDEP<-allDEP %>% rownames_to_column(var="ID")
```

we want to extract out the protein names from ID
```{r}
ID$protein<-sapply(strsplit(ID$Description, split= "GN="), "[", 2)
ID$protein<-sub(" .*", "", ID$protein)
ID$protein<-gsub("0","o",ID$protein)
```




Now we filter for upregulated enrichment of proteins and only correct for those for FDR

```{r}
allDEPup<-allDEP[allDEP$logFC>1,]
rownames(allDEPup)
allDEPup<-merge(allDEPup,ID,by.x="ID",by.y="ID",all.x=TRUE)
allvsbg.pval<-allDEPup$P.Value
Allvsbg.padj<-p.adjust(allvsbg.pval,method="fdr",n=length(allvsbg.pval))
colnames(allDEPup)
```
"adj.P.val" column is generated by correcting for all values instead of only upregulated one, this column will be deleted to be replaced by "Allvsbg.padj"- that is only FDR corrected for those upregulated ones

```{r}

allDEPup<-cbind(select(allDEPup,-"adj.P.Val"),Allvsbg.padj)
                
allDEsigup<- allDEPup[allDEPup$Allvsbg.padj<0.1,]
```
saving list of Differentially Enriched TSPO interactors

```{r}
write.xlsx(allDEsigup,file="allDEvsbg_upreg070821.xlsx",sheetName = "All enriched(APP+WT)versusKO")
```


I saved the following object(those enriched in WT vs KO)  in excel using following command
#write.xlsx(WT.vs.KOsigup,file="allDEvsbg_upreg070821.xlsx",sheet="WTvsKOenriched",append=TRUE)


Let's plot volcano plots

use the allvsbg one, include downreg also 
use pvalue
but keep those FDR sig as orange


```{r}
str(allDEPup)

 keyvals <- ifelse(
    allDEP$ID%in%rownames(allDEsigup), 'orange',
     "grey")
 
  names(keyvals)[keyvals == 'orange'] <- 'Sig. enriched'
  names(keyvals)[keyvals == 'grey'] <- 'NS'
  
allvsKO<-EnhancedVolcano(allDEP,
    lab = NA,
    x = 'logFC',
    y = 'P.Value',
    xlim = c(-1,6.5),
    ylim = c(0,5),
    title = 'Enriched against TSPOKO',
    pCutoff = 0.05,
    FCcutoff = 1,
    legendPosition = "right",
    border = "full",
    borderWidth = 2.0,
    borderColour = "black",
    gridlines.major = TRUE,
    gridlines.minor = FALSE,
    colCustom = keyvals,
    legendLabSize = 30,
    legendIconSize = 10.0,
  cutoffLineType = 'twodash',
    cutoffLineWidth = 0.8,
    pointSize = c(ifelse(allDEP$ID%in%rownames(allDEsigup), 3, 2)), axisLabSize = 40,
titleLabSize = 45)

```
I have saved the tiff using the following command with this filename
#ggsave(plot =allvsKO ,'IPTSPO_allvsbg.tiff', units="in", width=10, height=9, dpi=400)
